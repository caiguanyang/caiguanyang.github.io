# mongodb 副本集学习

[TOC]

## 副本集组成--节点说明

参考：https://docs.mongodb.com/manual/core/replica-set-members/

由一组 mongod实例组成，提供了**数据冗余度和高可用**。

### primary

一个副本集只有一个主节点，**接收所有的写操作**，并将操作信息记录到 oplog 中，供从节点同步数据使用。

​       读操作默认也是分发到主节点的，但可以通过副本集读选项修改此行为，集群中的 secondary 节点也是可以用于读操作的。

**读选项：**

| 副本集读选项             | 说明                                       |
| ------------------ | ---------------------------------------- |
| primary            | 默认模式，所有读操作都在 primary节点                   |
| primaryPreferred   | 大多情况在 primary 节点，当 primary 不可用时，使用 secondary节点 |
| secondary          | 所有读操作都在secondary 节点                      |
| secondaryPreferred | 大多情况在 secondary 节点，secondary 不可用时，切换到 primary 节点 |
| nearest            | 会选择网络延迟最小的节点进行读，与节点类型无关                  |

### secondary

​     根据主节点的 oplog，备份集群数据。

​    当前 primary 节点不可用时，副本集会自动触发选主过程，secondary 节点可以上升为 primary 节点。

**节点类型：**

| 类别    | 说明                                       | 意义                                       |
| ----- | ---------------------------------------- | ---------------------------------------- |
| 优先级为0 | 不会触发选主，参与投票，**但不会升级为 primary**；能接收读请求    | 在特殊部署环境下，**可以优先保证更符号条件的节点上升为主节点**        |
| 隐藏节点  | **不可读**；参与投票，但不会升级为 primary；要求 **priority 必须设置为0** | 可作为备份节点，在不需要执行 db.fsyncLock 的情况下完成备份；参与投票 |
| 延时节点  | priority=0；隐藏节点；可以控制是否参与投票；相比主节点的数据延后指定时间 | 用于帮助在人为误操作或其他意外情况下恢复数据                   |



### arbiter





## 选主过程



### 细节问题

* 如果副本集中只有少数节点可用，**无主**。集群还能对外提供正常的读服务吗？





## 副本集备份

http://docs.mongoing.com/core/backups.html



## 主从同步原理



## oplog





